// Cesium ionのアクセストークン
Cesium.Ion.defaultAccessToken =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyOGRiZmY3Yy0wNzRjLTQ2MjktOGQ0Ni0xYmI5MzFmNDUxZDAiLCJpZCI6MzU0MDY0LCJpYXQiOjE3NjE0NTQ3MDh9.p9q4yTuNNbVz7U09nx04n-LQG0sxXh8TDw22H3FSIV0";

(async function () {
    // ===== Viewer =====
    const viewer = new Cesium.Viewer("cesiumContainer", {
        baseLayerPicker: false,
        timeline: false,
        animation: false,
        geocoder: false,
        homeButton: false
    });
    // ★★ ここを追加：既定のベースレイヤーを完全に除去 ★★
    while (viewer.imageryLayers.length > 0) {
        viewer.imageryLayers.remove(viewer.imageryLayers.get(0), false);
    }
    // ↑ これで「最初から載ってるレイヤー」はゼロになります

    // 光源＆時間（任意）
    viewer.scene.globe.enableLighting = true;
    viewer.clock.currentTime = Cesium.JulianDate.fromDate(new Date("2024-06-21T12:00:00Z"));
    viewer.clock.shouldAnimate = false;

    // ===== 地形 =====
    const terrainProvider = await Cesium.CesiumTerrainProvider.fromIonAssetId(2767062);
    viewer.terrainProvider = terrainProvider;

    // ===== 画像レイヤーの用意 =====
    const layers = viewer.imageryLayers;

    // 衛星（Ion）
    const satelliteProvider = await Cesium.IonImageryProvider.fromAssetId(3830183);

    // 地理院 標準地図
    const gsiProvider = new Cesium.UrlTemplateImageryProvider({
        url: 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
        credit: new Cesium.Credit('<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">地理院タイル</a>'),
        minimumLevel: 2,
        maximumLevel: 18
    });

    // 古地図4枚（※ kitakomatsu のURL先頭の空白は消しておきます）
    const kitakomatsuProvider = new Cesium.UrlTemplateImageryProvider({
        url: 'https://mapwarper.h-gis.jp/maps/tile/815/{z}/{x}/{y}.png',
        credit: new Cesium.Credit('<a href="http://purl.stanford.edu/hf547qg6944" target="_blank">…北小松…</a>'),
        minimumLevel: 2,
        maximumLevel: 18
    });
    const kumagawaProvider = new Cesium.UrlTemplateImageryProvider({
        url: 'https://mapwarper.h-gis.jp/maps/tile/845/{z}/{x}/{y}.png',
        credit: new Cesium.Credit('<a href="http://purl.stanford.edu/cb173fj2995" target="_blank">…熊川…</a>'),
        minimumLevel: 2,
        maximumLevel: 18
    });
    const chikubushimaProvider = new Cesium.UrlTemplateImageryProvider({
        url: 'https://mapwarper.h-gis.jp/maps/tile/846/{z}/{x}/{y}.png',
        credit: new Cesium.Credit('<a href="http://purl.stanford.edu/zt128hp6132" target="_blank">…竹生島…</a>'),
        minimumLevel: 2,
        maximumLevel: 18
    });
    const hikoneseibuProvider = new Cesium.UrlTemplateImageryProvider({
        url: 'https://mapwarper.h-gis.jp/maps/tile/816/{z}/{x}/{y}.png',
        credit: new Cesium.Credit('<a href="http://purl.stanford.edu/yn560bk7442" target="_blank">…彦根西部…</a>'),
        minimumLevel: 2,
        maximumLevel: 18
    });

    // レイヤーを一度だけ追加して参照を保持
    const layerSatellite = viewer.imageryLayers.addImageryProvider(satelliteProvider); // 衛星
    const layerGSI = viewer.imageryLayers.addImageryProvider(gsiProvider);            // 地理院

    // 古地図は上に重ねる前提で追加（順序はお好みで）
    const layerOlds = [
        viewer.imageryLayers.addImageryProvider(kumagawaProvider),
        viewer.imageryLayers.addImageryProvider(chikubushimaProvider),
        viewer.imageryLayers.addImageryProvider(hikoneseibuProvider),
        viewer.imageryLayers.addImageryProvider(kitakomatsuProvider),
    ];

    // 初期状態は「衛星」だけ表示に
    function allOff() {
        layerSatellite.show = false;
        layerGSI.show = false;
        layerOlds.forEach(l => (l.show = false));
    }
    allOff();
    layerSatellite.show = true;

    // 見た目の調整（任意）
    [layerSatellite, layerGSI, ...layerOlds].forEach(l => {
        l.alpha = 1.0;
        l.brightness = 0.95;
    });

    // 切替ヘルパ（排他的に）
    function showSatellite() {
        allOff();
        layerSatellite.show = true;
        // 衛星を最背面にしたいなら：
        viewer.imageryLayers.lowerToBottom(layerSatellite);
    }

    function showGSI() {
        allOff();
        layerGSI.show = true;
        viewer.imageryLayers.lowerToBottom(layerGSI);
    }

    function showOldMaps() {
        allOff();
        // ベース無しで古地図のみ表示（古地図の重なりがそのまま出ます）
        layerOlds.forEach(l => (l.show = true));
        // 必要なら一枚を最上面に
        viewer.imageryLayers.raiseToTop(layerOlds[layerOlds.length - 1]);
    }

    // 既存のボタンにイベントを付与（idはHTML側に合わせて）
    document.getElementById('btn-satellite').onclick = showSatellite;
    document.getElementById('btn-gsi').onclick = showGSI;
    document.getElementById('btn-old').onclick = showOldMaps;

    // --- ここまでイメージ切替 ---
    // ===== GeoJSON・ルート等はここから下にそのまま =====
    const routeGeojson = {
        "type": "FeatureCollection",
        "name": "route",
        "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
        "features": [
            {
                "type": "Feature",
                "properties": { "name": "A", "style": "Line" },
                "geometry": {
                    "type": "LineString", "coordinates": [
                        [135.976610482675341, 35.36482341576319], [135.976799968252664, 35.363827599101512], [135.978905363556464, 35.363106482816328], [135.979136957039884, 35.362144984416524], [135.981305514202774, 35.361801589355807], [135.982989830445803, 35.360599695141488], [135.986084761542372, 35.359397783035647], [135.989621825652762, 35.358813990700185], [135.991242980036645, 35.358161511918581], [135.988905991249453, 35.352924320188713], [135.989369178216293, 35.352769774945934], [135.988232264752241, 35.350108116027741], [135.993179943716143, 35.347669616032995], [135.996822277591662, 35.346433165374883], [135.997622327807107, 35.346673587818373], [135.998043406867851, 35.346656414810418], [135.998548701740759, 35.347308986546011], [136.002380521193629, 35.346982701337168], [136.008654599198934, 35.345626027652742], [136.009665188944751, 35.344801708464082], [136.011202127516469, 35.344750188235508], [136.01259168841699, 35.345763413366434], [136.015876105090939, 35.345368428809813], [136.020697460336578, 35.344252157665487], [136.020129003604552, 35.343118697337381], [136.020739568242675, 35.345282562346299], [136.021539618458121, 35.345969491498906], [136.022171237049236, 35.347412023706568], [136.023581851902776, 35.347583752015453], [136.024213470493891, 35.348631286793889], [136.025729355112617, 35.349197980273942], [136.026508351375014, 35.349404049644598], [136.026908376482737, 35.351670778024122], [136.027476833214735, 35.352271793818595], [136.02949801270637, 35.358985694766403], [136.030003307579307, 35.359191739163919], [136.03023490106267, 35.360273463624686], [136.030024361532355, 35.36035931415163], [136.032508727990802, 35.367261397807113], [136.033414047971462, 35.369802314812873], [136.032382404272596, 35.371639279315829], [136.032340296366499, 35.376943923400823], [136.033266670300208, 35.380205505538967], [136.032803483333367, 35.382231053341421], [136.033519317736648, 35.386487971101189], [136.035119418167511, 35.386590958263845], [136.033793019126108, 35.389096938693349], [136.033793019126108, 35.392272213020235], [136.034256206092977, 35.394983969953671], [136.03514047212056, 35.397438202993641], [136.03629843953766, 35.39989236133399], [136.036656356739286, 35.400561664280318], [136.036045792101191, 35.401711479446639], [136.037372191142595, 35.401883092244105], [136.037961701827641, 35.40262102311042], [136.038382780888384, 35.403101532601397], [136.039161777150781, 35.40454304388949], [136.03989866550711, 35.405658481361883], [136.043288351946245, 35.408335468319009], [136.044319995645111, 35.409450853310375], [136.045793772357712, 35.408060909645997]
                    ]
                }
            },
            {
                "type": "Feature",
                "properties": { "name": "B", "style": "arrow" },
                "geometry": {
                    "type": "MultiLineString", "coordinates": [[[135.979263280758033, 35.363149406585002, 800], [135.979800686519695, 35.363021121356489, 800], [135.980335797207971, 35.362883576440851, 800], [135.980868453287854, 35.362736812844986, 800], [135.981398495956199, 35.362580874324181, 800], [135.981925767188926, 35.362415807369111, 800], [135.982450109788289, 35.362241661191931, 800], [135.982971367429599, 35.362058487711629, 800], [135.98348938470798, 35.361866341538565, 800], [135.984004007184552, 35.361665279958146, 800], [135.98451508143259, 35.36145536291378, 800], [135.985022455083197, 35.361236652988993, 800], [135.985525976870747, 35.361009215388762, 800], [135.986025496677968, 35.360773117920111, 800], [135.986520865580786, 35.36052843097184, 800], [135.987011935892582, 35.360275227493602, 800], [135.987498561208326, 35.360013582974084, 800], [135.98798059644821, 35.359743575418577, 800], [135.988457897900844, 35.359465285325655, 800], [135.988930323266231, 35.359178795663212, 800], [135.989397731697977, 35.358884191843728, 800], [135.989859983845491, 35.35858156169877, 800], [135.990316941895429, 35.358270995452848, 800], [135.990768469612846, 35.357952585696495, 800], [135.991214432381668, 35.357626427358653, 800], [135.991654697244996, 35.357292617678411, 800], [135.992089132944699, 35.356951256175961, 800], [135.99251760996043, 35.356602444622965, 800], [135.99294000054843, 35.356246287012205, 800], [135.993356178779436, 35.355882889526569, 800], [135.993766020576317, 35.355512360507412, 800], [135.994169403751101, 35.355134810422228, 800], [135.994566208041334, 35.354750351831761, 800], [135.994956315145913, 35.354359099356387, 800], [135.995339608760418, 35.353961169642005, 800], [135.995715974611812, 35.353556681325209, 800], [135.996085300492439, 35.353145754997946, 800], [135.99644747629344, 35.352728513171556, 800], [135.996802394037701, 35.352305080240249, 800], [135.997149947912021, 35.351875582444002, 800], [135.997490034298522, 35.351440147830971, 800], [135.99782255180574, 35.350998906219253, 800], [135.998147401298723, 35.35055198915822, 800], [135.998464485928565, 35.350099529889292, 800], [135.998477650018685, 35.349959355787362, 800], [135.998493255567297, 35.349819432454879, 800], [135.998511297832124, 35.349679802412261, 800], [135.99853177133042, 35.349540508090811, 800], [135.998554669840615, 35.349401591819799, 800], [135.998579986404252, 35.349263095813626, 800], [135.998607713327999, 35.349125062158961, 800], [135.998637842186128, 35.348987532801992, 800], [135.998670363822981, 35.348850549535648, 800], [135.998705268355707, 35.348714153986911, 800], [135.998742545177436, 35.348578387604171, 800], [135.998782182960326, 35.348443291644614, 800], [135.998824169659116, 35.348308907161709, 800], [135.998868492514703, 35.348175274992705, 800], [135.998915138058152, 35.348042435746251, 800], [135.998964092114562, 35.347910429790019, 800], [135.99901533980767, 35.347779297238475, 800], [135.999068865564084, 35.347649077940673, 800], [135.999124653118201, 35.347519811468125, 800], [135.999182685517127, 35.347391537102808, 800], [135.999242945125729, 35.347264293825219, 800], [135.999305413632101, 35.34713812030251, 800], [135.999370072053097, 35.347013054876768, 800], [135.999436900740051, 35.34688913555334, 800], [135.999505879384827, 35.346766399989278, 800], [135.999576987025932, 35.346644885481929, 800], [135.999650202054937, 35.346524628957575, 800], [135.999725502222958, 35.346405666960209, 800], [135.999802864647506, 35.346288035640455, 800], [135.999882265819394, 35.34617177074454, 800], [135.999963681609927, 35.346056907603483, 800], [136.000047087278148, 35.345943481122319, 800], [136.000132457478458, 35.345831525769505, 800], [136.000219766268202, 35.345721075566459, 800], [136.000308987115687, 35.345612164077188, 800], [136.000400092908137, 35.345504824398127, 800], [136.000493055960021, 35.345399089148053, 800], [136.000587848021325, 35.345294990458186, 800], [136.000684440286335, 35.345192559962427, 800], [136.000782803402217, 35.34509182878773, 800], [136.000882907478001, 35.344992827544658, 800], [136.000984722093733, 35.344895586318081, 800], [136.001088216309569, 35.344800134658023, 800], [136.001193358675323, 35.344706501570684, 800], [136.001300117239936, 35.344614715509643, 800], [136.001408459561219, 35.344524804367182, 800], [136.001518352715721, 35.344436795465839, 800], [136.001629763308671, 35.344350715550078, 800], [136.001742657484243, 35.344266590778183, 800], [136.001857000935701, 35.344184446714316, 800], [136.00197275891594, 35.344104308320702, 800], [136.002089896248009, 35.344026199950108, 800], [136.002208377335762, 35.343950145338383, 800], [136.002328166174749, 35.343876167597301, 800], [136.002449226363069, 35.343804289207476, 800], [136.002571521112543, 35.343734532011588, 800], [136.002695013259711, 35.34366691720772, 800], [136.0028196652774, 35.343601465342893, 800], [136.002945439285867, 35.343538196306874, 800], [136.003072297064392, 35.343477129326097, 800], [136.003200200063048, 35.343418282957806, 800], [136.003329109414125, 35.343361675084466, 800], [136.003458985944206, 35.343307322908295, 800], [136.003589790185913, 35.343255242946015, 800], [136.003721482389977, 35.343205451023891, 800], [136.003854022537297, 35.343157962272876, 800], [136.003987370351041, 35.343112791124028, 800], [136.004121485309014, 35.343069951304116, 800], [136.004256326655849, 35.343029455831477, 800], [136.004391853415456, 35.342991317012014, 800], [136.00452802440347, 35.342955546435491, 800], [136.004998019290269, 35.342877514420145, 800], [136.005469283385878, 35.342807554851724, 800], [136.005941678051585, 35.342745688311261, 800], [136.006415064316087, 35.34269193299896, 800], [136.006889302916363, 35.342646304728795, 800], [136.007364254338626, 35.342608816923928, 800], [136.00783977885942, 35.342579480612692, 800], [136.008315736586667, 35.342558304425381, 800], [136.008791987500842, 35.342545294591709, 800], [136.009268391496192, 35.34254045493897, 800], [136.009744808421914, 35.342543786890921, 800], [136.010221098123424, 35.342555289467349, 800], [136.010697120483542, 35.342574959284363, 800], [136.011172735463731, 35.342602790555411, 800], [136.011647803145308, 35.342638775092965, 800], [136.012122183770629, 35.342682902310905, 800], [136.012595737784096, 35.342735159227686, 800], [136.013068325873348, 35.34279553047012, 800], [136.013539809010183, 35.342863998277899, 800], [136.014010048491457, 35.342940542508842, 800], [136.014478905979843, 35.343025140644812, 800], [136.014946243544614, 35.343117767798311, 800], [136.015411923702231, 35.343218396719848, 800], [136.015875809456617, 35.343326997805924, 800], [136.016337764339681, 35.343443539107767, 800], [136.016797652451345, 35.34356798634068, 800], [136.017255338499524, 35.343700302894206, 800], [136.017710687839951, 35.343840449842808, 800], [136.018163566515767, 35.34398838595741, 800], [136.018613841296997, 35.344144067717444, 800], [136.019061379719659, 35.344307449323722, 800], [136.019506050124761, 35.34447848271185, 800], [136.019947721697037, 35.344657117566427, 800], [136.020386264503458, 35.344843301335786, 800], [136.020821549531377, 35.345036979247503, 800], [136.021253448726611, 35.345238094324493, 800], [136.021681835030961, 35.34544658740176, 800], [136.022106582419724, 35.345662397143812, 800], [136.022527565938674, 35.345885460062718, 800], [136.022944661740894, 35.346115710536765, 800], [136.023357747123157, 35.346353080829772, 800], [136.023766700561993, 35.346597501111006, 800], [136.024171401749584, 35.346848899475752, 800], [136.024571731628981, 35.347107201966445, 800], [136.024967572429205, 35.347372332594418, 800], [136.025358807699973, 35.34764421336228, 800], [136.025745322345813, 35.347922764286857, 800], [136.02612700265999, 35.348207903422711, 800], [136.026503736357995, 35.348499546886245, 800], [136.02687541261048, 35.348797608880403, 800], [136.027241922075973, 35.349102001719885, 800], [136.027603156932969, 35.349412635856964, 800], [136.028019738322229, 35.349891614720285, 800], [136.028428031329526, 35.350377678116935, 800], [136.028827915493792, 35.350870682640789, 800], [136.029219272834865, 35.351370482837837, 800], [136.02960198788827, 35.351876931249095, 800], [136.029975947739388, 35.352389878454112, 800], [136.030341042056619, 35.352909173115073, 800], [136.030697163124046, 35.353434662021435, 800], [136.031044205873172, 35.353966190135125, 800], [136.031382067913995, 35.354503600636285, 800], [136.031710649565042, 35.355046734969548, 800], [136.03202985388296, 35.355595432890809, 800], [136.032339586691023, 35.356149532514507, 800], [136.032639756606983, 35.356708870361373, 800], [136.032930275069901, 35.357273281406691, 800], [136.033211056366412, 35.357842599128965, 800], [136.033482017656013, 35.358416655559047, 800], [136.033743078995371, 35.358995281329705, 800], [136.033994163362053, 35.359578305725584, 800], [136.034235196677116, 35.360165556733584, 800], [136.034466107827143, 35.360756861093599, 800], [136.034686828685039, 35.36135204434963, 800], [136.034897294130246, 35.361950930901287, 800], [136.035097442067894, 35.362553344055549, 800], [136.035287213447191, 35.363159106078939, 800], [136.035466552278734, 35.36376803824993, 800], [136.035635405651192, 35.364379960911705, 800], [136.035793723746707, 35.364994693525126, 800], [136.035941459855792, 35.365612054722028, 800], [136.036078570391027, 35.366231862358731, 800], [136.036205014899821, 35.366853933569743, 800], [136.036320756076549, 35.367478084821748, 800], [136.036425759773437, 35.368104131967755, 800], [136.036519995010565, 35.368731890301397, 800], [136.036603433985221, 35.369361174611456, 800], [136.036676052079855, 35.369991799236495, 800], [136.036737827869587, 35.370623578119627, 800], [136.036788743128312, 35.371256324863445, 800], [136.036828782834192, 35.371889852784946, 800], [136.036857935174112, 35.37252397497069, 800], [136.036876191547037, 35.37315850433189, 800], [136.036883546566742, 35.373793253659628, 800], [136.036879998063171, 35.37442803568009, 800], [136.036865547083323, 35.375062663109809, 800], [136.036840197890712, 35.375696948710946, 800], [136.036803957964253, 35.376330705346497, 800], [136.036756837996052, 35.376963746035536, 800], [136.03669885188819, 35.377595884008343, 800], [136.036630016748632, 35.378226932761564, 800], [136.036550352886195, 35.378856706113176, 800], [136.036459883804611, 35.379485018257455, 800], [136.036358636195502, 35.380111683819798, 800], [136.036246639930511, 35.38073651791138, 800], [136.036123928052604, 35.381359336183742, 800], [136.035990536766121, 35.381979954883164, 800], [136.035846505426321, 35.382598190904865, 800], [136.035691876527608, 35.383213861847054, 800], [136.035526695691033, 35.383826786064724, 800], [136.035351011650874, 35.384436782723249, 800], [136.035198126049892, 35.384643904937114, 800], [136.035048850976693, 35.384853644230006, 800], [136.034903231220397, 35.385065937670873, 800], [136.034761310473328, 35.385280721562296, 800], [136.034623131318, 35.385497931459618, 800], [136.034488735214296, 35.385717502190289, 800], [136.03435816248691, 35.38593936787337, 800], [136.03423145231352, 35.386163461939368, 800], [136.034108642712681, 35.386389717150159, 800], [136.03398977053277, 35.386618065619182, 800], [136.033874871440673, 35.386848438831805, 800], [136.033763979911186, 35.3870807676659, 800], [136.033657129216692, 35.387314982412533, 800], [136.033554351417081, 35.387551012796955, 800], [136.033455677350247, 35.387788787999604, 800], [136.033361136622773, 35.388028236677428, 800], [136.033270757601059, 35.388269286985242, 800], [136.033184567402799, 35.388511866597298, 800], [136.033102591888849, 35.388755902728995, 800], [136.033024855655498, 35.389001322158727, 800], [136.032951382027079, 35.389248051249808, 800], [136.032882193048863, 35.389496015972611, 800], [136.032817309480663, 35.389745141926774, 800], [136.032756750790355, 35.389995354363499, 800], [136.03270053514828, 35.390246578208, 800], [136.032648679421555, 35.39049873808203, 800], [136.03260119916925, 35.390751758326481, 800], [136.032558108637517, 35.391005563024102, 800], [136.032519420755392, 35.391260076022277, 800], [136.032485147130984, 35.391515220955853, 800], [136.032455298047864, 35.391770921270087, 800], [136.032429882462083, 35.392027100243581, 800], [136.032408907999468, 35.392283681011335, 800], [136.03239238095324, 35.392540586587771, 800], [136.032380306282278, 35.392797739889879, 800], [136.032372687609524, 35.393055063760293, 800], [136.032369527220879, 35.393312480990495, 800], [136.032370826064636, 35.393569914343942, 800], [136.032376583751045, 35.393827286579253, 800], [136.032386798552579, 35.394084520473385, 800], [136.032401467404327, 35.394341538844813, 800], [136.032420585904987, 35.394598264576665, 800], [136.032444148318177, 35.394854620639876, 800], [136.03247214757414, 35.395110530116305, 800], [136.032504575271815, 35.395365916221813, 800], [136.032541421681515, 35.395620702329268, 800], [136.032582675747676, 35.395874811991597, 800], [136.032628325092219, 35.396128168964665, 800], [136.03267835601838, 35.396380697230192, 800], [136.032732753514637, 35.396632321018544, 800], [136.032791501259311, 35.396882964831462, 800], [136.032854581625543, 35.397132553464736, 800], [136.032921975686406, 35.397381012030742, 800], [136.032993663220708, 35.397628265980941, 800], [136.033069622719012, 35.397874241128214, 800], [136.033149831390119, 35.398118863669161, 800], [136.03323426516792, 35.39836206020621, 800], [136.033322898718467, 35.398603757769656, 800], [136.033415705447879, 35.398843883839547, 800], [136.033512657509959, 35.399082366367459, 800], [136.033613725814831, 35.399319133798095, 800], [136.033718880037554, 35.399554115090766, 800], [136.033828088627189, 35.399787239740704, 800], [136.033941318816375, 35.400018437800213, 800], [136.034058536631022, 35.400247639899668, 800], [136.034179706900602, 35.400474777268307, 800], [136.034304793268689, 35.400699781754881, 800], [136.034433758203846, 35.400922585848114, 800], [136.034566563010884, 35.401143122696929, 800], [136.034703167842537, 35.401361326130527, 800], [136.034843531711289, 35.401577130678241, 800], [136.034987612501766, 35.401790471589166, 800], [136.035135366983383, 35.402001284851615, 800], [136.035286750823246, 35.402209507212291, 800], [136.035441718599571, 35.402415076195282, 800], [136.035600223815123, 35.402617930120819, 800], [136.035762218911344, 35.402818008123759, 800], [136.035927655282563, 35.403015250171855, 800], [136.036096483290549, 35.403209597083794, 800], [136.03626865227946, 35.403400990546899, 800], [136.036444110590963, 35.403589373134693, 800], [136.036622805579839, 35.403774688324063, 800], [136.036804683629697, 35.403956880512276, 800], [136.036989690169065, 35.404135895033612, 800], [136.037177769687815, 35.404311678175823, 800], [136.03736886575382, 35.404484177196196, 800], [136.037562921029746, 35.40465334033739, 800], [136.037759877290512, 35.404819116843008, 800], [136.037959675440476, 35.404981456972763, 800], [136.038162255531404, 35.405140312017451, 800], [136.038367556780287, 35.405295634313539, 800], [136.038575517587731, 35.405447377257474, 800], [136.03878607555626, 35.405595495319666, 800], [136.038999167509218, 35.405739944058155, 800], [136.039214729509553, 35.405880680131943, 800], [136.039432696879203, 35.406017661313989, 800], [136.03965300421828, 35.406150846503884, 800], [136.03987558542488, 35.40628019574018, 800], [136.040100373714807, 35.406405670212408, 800], [136.040327301641611, 35.406527232272673, 800], [136.040556301116908, 35.406644845446984, 800], [136.040787303430761, 35.4067584744462, 800], [136.041020239272228, 35.40686808517659, 800], [136.041255038750279, 35.40697364475011, 800], [136.041491631414743, 35.407075121494209, 800], [136.041729946277314, 35.407172484961393, 800], [136.041969911833007, 35.407265705938308, 800], [136.042211456081588, 35.407354756454545, 800], [136.042454506549063, 35.407439609791027, 800], [136.042698990309617, 35.40752024048799, 800], [136.042944834007272, 35.407596624352671, 800], [136.043191963878087, 35.407668738466526, 800], [136.043440305772151, 35.407736561192152, 800], [136.043689785175957, 35.407800072179718, 800], [136.043940327234623, 35.407859252373136, 800], [136.044191856774518, 35.407914084015722, 800], [136.044444298325629, 35.407964550655571, 800], [136.04469757614433, 35.408010637150454, 800], [136.044951614236112, 35.408052329672387, 800]
                    ]]
                }
            }
        ]
    };

    try {
        const ds = await Cesium.GeoJsonDataSource.load(routeGeojson);
        viewer.dataSources.add(ds);
        const entities = ds.entities.values;

        for (const entity of entities) {
            const p = entity.properties;
            const style = p?.style?.getValue?.();
            const name = entity.name ?? p?.name?.getValue?.();

            if (entity.polyline) {
                entity.polyline.width = 5;

                if (style === "arrow" || name === "B") {
                    const yellowTrans = Cesium.Color.YELLOW.withAlpha(0.5);
                    entity.polyline.width = 25;
                    entity.polyline.material = new Cesium.PolylineArrowMaterialProperty(yellowTrans);
                    entity.polyline.clampToGround = false;
                    entity.polyline.heightReference = Cesium.HeightReference.NONE;
                } else {
                    entity.polyline.material = new Cesium.PolylineDashMaterialProperty({
                        color: Cesium.Color.RED,
                        gapColor: Cesium.Color.TRANSPARENT,
                        dashLength: 17,
                    });
                    entity.polyline.width = 4;
                    entity.polyline.clampToGround = true;
                }
            }
        }


        // スタートのポイント
        viewer.entities.add({
            position: Cesium.Cartesian3.fromDegrees(135.9764736, 35.3648148, 184),
            point: {
                pixelSize: 8,
                color: Cesium.Color.RED,
                outlineColor: Cesium.Color.WHITE,
                outlineWidth: 2
            },
            label: {
                text: 'Start',
                font: '14pt sans-serif',
                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                fillColor: Cesium.Color.WHITE,
                outlineColor: Cesium.Color.BLACK,
                outlineWidth: 3,
                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                pixelOffset: new Cesium.Cartesian2(0, -9)
            }
        });

        // ゴールのポイント
        viewer.entities.add({
            position: Cesium.Cartesian3.fromDegrees(136.045836, 35.408181, 134),
            point: {
                pixelSize: 8,
                color: Cesium.Color.RED,
                outlineColor: Cesium.Color.WHITE,
                outlineWidth: 2
            },
            label: {
                text: 'Finish',
                font: '14pt sans-serif',
                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                fillColor: Cesium.Color.WHITE,
                outlineColor: Cesium.Color.BLACK,
                outlineWidth: 3,
                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                pixelOffset: new Cesium.Cartesian2(0, -9)
            }
        });

        viewer.flyTo(ds);
    } catch (e) {
        console.error("GeoJSON読み込みエラー:", e);
    }
})();
